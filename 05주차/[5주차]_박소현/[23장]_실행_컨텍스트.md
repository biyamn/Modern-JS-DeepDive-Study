# :fire: 23장. 실행 컨텍스트

- 자바스크립트의 동작 원리를 담고 있는 핵심 개념이다.
  - 스코프, 식별자, 식별자 바인딩, 호이스팅, 클로저, 태스크 큐, 이벤트 핸들러, 비동기 처리 동작 방식을 이해할 수 있다.

## :one: 소스코드의 타입

소스코드 타입에 맞는 실행 컨텍스트가 따로 있다.

- 전역 코드
  - 전역 스코프 생성
  - 전역 변수와 전역 함수를 전역 객체의 프로퍼티와 메서드로 바인딩
    
- 함수 코드
  - 지역 스코프 생성
  - 지역 변수, 매개변수, arguments 객체 관리
  - 지역 스코프를 체인에 연결

- eval 코드
  - 엄격 모드에서 자신만의 독자적인 스코프 생성.
    
- 모듈 코드
  - 모듈별로 독립적인 모듈 스코프 생성.

---

## :two: 소스코드 평가와 실행

자바스크립트 엔진은 소스코드를 평가와 실행 이 2개의 과정으로 나누어 처리한다.

```
var x; // 1.
x = 1; // 2.
```

1. 소스코드의 평가 과정: 변수 선언문을 실행한다. (선언 + 초기화)
2. 소스코드의 실행 과정: 평가 과정이 끝난 후 시작된다. 선언 및 초기화는 평가 과정에서 완료되었으므로, 할당만 실행된다.

---

## :three: 실행 컨텍스트의 역할

1. 전역 코드 평가: 전역 코드의 변수 선언무노가 함수 선언문 먼저 실행, 전역 스코프에 등록.
2. 전역 코드 실행: 런타임 시작. 전역 코드가 순차적으로 실행된다(변수의 값 할당, 함수 호출). 함수가 호출되면 전역코드 실행 중단하고 함수 내부로 진입한다.
3. 함수 코드 평가: 함수 코드를 실행하기 위한 준비. 매개변수와 지역 변수 선언문 실행. 지역 스코프에 등록. arguments 객체 생성, this 바인딩
4. 함수 코드 실행: 코드 순차적으로 실행(매개변수 및 지역 변수 값 할당, console.log 메서드 호출).
  - console.log: 이 메서드를 호출하기 위해 console 식별자를 스코프 체인을 통해 검색한다.그 후 log 프로퍼티를 console 객체의 프로토타입 체인을 통해 검색한다.
  - 코드가 실해오디려면 스코프를 구분하여 식별자와 바인딩된 값이 관리되어야한다.
  - 함수 호출이 종료되려면 함수 호출 이전으로 되돌아가기 위해 실행 중인 코드와 실행하던 코드를 구분하여 관리해야한다. **(스코프, 식별자, 코드 실행 순서 등의 관리가 필요)**

**이 모든 것을 관리하는 것이 실행 컨텍스트.** 소스코드를 실행하는데 필요한 환경을 제공하고, 코드 실행 결과를 실제로 관리한다. 
- 식별자와 스코프는 렉시컬 환경으로 관리.
- 코드 실행 순서는 실행 컨텍스트 스택으로 관리.

---

## :four: 실행 컨텍스트 스택

생성된 실행 컨텍스트는 스택 자료구조로 관리되는데, 이를 실행 컨텍스트 스택이라고 부른다. 코드가 실행됨에 따라 실행 컨텍스트 스택에는 실행 컨텍스트가 push되고 pop 된다. 실행 컨텍스트 스택의 최상위 컨텍스트는 현재 실행중인 코드이다.

---

## :five: 렉시컬 환경

- 식별자와 그에 바인딩된 값, 상위 스코프에 대한 참조를 기록하는 자료 구조. 저장소 역할.
- 실행 컨텍스트를 구성하는 컴포넌트.
- ↔ VariableEnvironment
  - 생성초기에 LexicalEnvironment 컴포넌트와 VariableEnvironment 컴포넌트는 하나의 동일한 렉시컬 환경을 참조한다. 
- 렉시컬 환경은 두 개의 컴포넌트로 구성된다.
  - 환경 레코드: 스코프에 포함된 식별자 등록하고 식별자에 바인딩된 값을 관리하는 저장소.
  - 외부 겍시컬 환경에 대한 참조: 상위 스코프. 스코프 체인 구현. 

---

## :six: 실행 컨텍스트의 생성과 식별자 검색 과정

1. 전역 객체 생성: 빌트인 전역 프로퍼티, 빌트인 전역 함수, 표준 빌트인 객체 추가. 호스트 객체 추가. Object.prototype 상속 받음.
2. 전역 코드 평가
  - 전역 실행 컨텍스트 생성: 실행 컨텍스트를 생성하여 스택에 push.
  - 전역 렉시컬 환경 셍성: 전역 실행 컨텍스트에 바인딩.
    - 전역 환경 레코드 생성: 전역 스코프, 전역 프로퍼티, 전역 함수, 표준 빌트인 객체 제공.
      - 객체 환경 레코드 생성: var 키워드 전역 변수, 전역 함수, 빌트인 전역 함수, 표준 빌트인 객체 관리
      - 선언적 환경 레코드 생성: let, const 키워드로 선언한 전역 변수 관리.
    - this바인딩: 전역 환경레코드의 GlobalThisValue 내부 슬롯에 this(전역 객체)가 바인딩 된다.
    - 외부 렉시컬 환경에 대한 참조 결정
3. 전역 코드 실행: 코드 실행. 변수 값 할당. 함수 호출.어느 스코프의 식별자를 참조하면 되는지 결정한다. 이를 위해 식별자 검색을 한다.
4. 함수 코드 평가
  - 함수 실행 컨텍스트 생성: 실행 컨텍스트 생성. 함수 렉시컬 환경이 완성되면 스택에 push.
  - 함수 렉시컬 환경 생성: 렉시컬 환경 생성 후 함수 실행 컨텍스트에 바인딩한다.
    - 함수 환경 레코드 생성: 매개변수, argument객체, 지역변수와 중첩 함수를 등록하고 관리한다.
    - this 바인딩: ThisValue 내부 슬롯에 this가 바인딩 된다.
    - 외부 렉시컬 환경에 대한 참조 결정: 함수 정의가 평가된 시점에 실행 중인 실행 컨텍스트(전역 실행 컨텍스트)의 렉시컬 환경의 참조가 할당된다.
5. 함수 코드 실행
6. 함수 코드 실행 종료
7. 전역 코드 실행 종료

---

## :seven: 실행 컨텍스트의 생성과 블록 레벨 스코프

let과 const의 블록 레벨 스코프 생성을 위한 렉시컬 환경이 필요하다. 선언적 환경 레코드를 갖는 렉시컬 환경을 생성한 후 전역 렉시컬 환경을 교체한다.

for문의 변수 선언문에서 let 키워드라 사용되었을 경우 반복 실행될 때마다 새로운 렉시컬 환경을 생성한다.
